---

import { profileConfig, siteConfig } from "../config";
import { url } from "../utils/url-utils";
import { getBuildInfo } from "../utils/build-info";

const currentYear = new Date().getFullYear();
const buildInfo = getBuildInfo();

// 格式化构建时间
function formatBuildTime(isoString: string): string {
	try {
		const date = new Date(isoString);
		return date.toLocaleString("zh-CN", {
			year: "numeric",
			month: "2-digit",
			day: "2-digit",
			hour: "2-digit",
			minute: "2-digit",
			second: "2-digit",
			timeZone: "Asia/Shanghai",
		});
	} catch {
		return isoString;
	}
}

const formattedBuildTime = formatBuildTime(buildInfo.buildTime);
const repositoryUrl = siteConfig.repository?.url || "";
const branch = siteConfig.repository?.branch || "main";
const commitUrl = buildInfo.commitHash
	? `${repositoryUrl}/commit/${buildInfo.commitHash}`
	: repositoryUrl;

// 服务商：在纯静态 Pages 托管下，不再动态检测，只通过构建环境变量指定
const envProvider = import.meta.env.PUBLIC_SERVICE_PROVIDER;
const serviceProvider =
	envProvider === "cloudflare" || envProvider === "esa" || envProvider === "edgeone"
		? envProvider
		: null;
---

<div class="transition border-t border-black/10 dark:border-white/15 my-10 border-dashed mx-32"></div>
<div class="card-base card-shadow py-8 mb-12 flex flex-col items-center justify-center px-6">
    <div class="transition text-50 text-sm text-center">
        &copy; 2022 - <span id="copyright-year">{currentYear}</span> <a class="transition link text-[var(--primary)] font-medium" target="_blank" href="https://space.bilibili.com/349638942">{profileConfig.name}</a> 版权所有
        {(buildInfo.commitHash || buildInfo.buildTime) && (
            <span class="text-xs text-gray-500 dark:text-gray-400 ml-2">
                {buildInfo.commitHash && (
                    <>
                        {repositoryUrl ? (
                            <a
                                class="transition link text-[var(--primary)] font-medium"
                                target="_blank"
                                href={commitUrl}
                                title={`Commit: ${buildInfo.commitHash}`}
                            >
                                {buildInfo.commitHash}
                            </a>
                        ) : (
                            <span title={`Commit: ${buildInfo.commitHash}`}>{buildInfo.commitHash}</span>
                        )}
                    </>
                )}
                {buildInfo.commitHash && buildInfo.buildTime && " · "}
                {buildInfo.buildTime && (
                    <span title={`构建时间: ${buildInfo.buildTime}`}>
                        {formattedBuildTime}
                    </span>
                )}
            </span>
        )}
        <br>
        <a class="transition link text-[var(--primary)] font-medium" target="_blank" href={url('rss.xml')}>RSS</a>  /
        <a class="transition link text-[var(--primary)] font-medium" target="_blank" href={url('sitemap-index.xml')}>网页地图</a>  /
        <a class="transition link text-[var(--primary)] font-medium" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"> CC BY-NC-SA 4.0</a><br>
        <span class="inline-flex items-center gap-2">
            <img src="/favicon/foot-ga.png" alt="公安备案" class="inline-block h-4 align-middle" />
            <a class="transition link text-[var(--primary)] font-medium" target="_blank" href="https://www.beian.gov.cn/portal/registerSystemInfo?recordcode=51080202020049">
                川公网安备51080202020049号
            </a>
        </span>
        <span class="inline-flex items-center gap-2">
            <img src="/favicon/foot-icp.png" alt="ICP备案" class="inline-block h-4 align-middle" />
            <a class="transition link text-[var(--primary)] font-medium" target="_blank" href="https://beian.miit.gov.cn/">
                蜀ICP备2024102137号
            </a>
        </span>
        <br>
        由
        <a class="transition link text-[var(--primary)] font-medium" target="_blank" href="https://astro.build">Astro</a> &
        <a class="transition link text-[var(--primary)] font-medium" target="_blank" href="https://github.com/saicaca/fuwari">Fuwari</a>
        <span id="service-provider-container">
            {serviceProvider === 'cloudflare' && (
                <>
                    & <a class="transition link text-[var(--primary)] font-medium inline-flex items-center gap-1 align-middle" target="_blank" href="https://www.cloudflare.com">
                        <img src="/favicon/foot-cloudflare.png" alt="Cloudflare" class="h-4" />
                    </a>
                </>
            )}
            {serviceProvider === 'esa' && (
                <>
                    & <a class="transition link text-[var(--primary)] font-medium inline-flex items-center gap-1 align-middle" target="_blank" href="https://www.aliyun.com/product/esa">
                        <img src="/favicon/foot-esa.png" alt="阿里云ESA" class="h-4" />
                    </a>
                </>
            )}
            {serviceProvider === 'edgeone' && (
                <>
                    & <a class="transition link text-[var(--primary)] font-medium inline-flex items-center gap-1 align-middle" target="_blank" href="https://cloud.tencent.com/product/teo">
                        <img src="/favicon/foot-edgeone.png" alt="腾讯EdgeOne" class="h-4" />
                    </a>
                </>
            )}
        </span>
        驱动
    </div>
</div>

<script define:vars={{ envProvider }}>
    // 客户端检测服务商：在纯静态部署下，只信任构建时注入的 envProvider
    (async function() {
        const container = document.getElementById('service-provider-container');
        if (!container) return;
        
        // 如果服务端已经检测到了，就不需要客户端检测
        if (container.innerHTML.trim() !== '') return;
        
        // 只使用环境变量（构建时/部署时注入）
        if (envProvider === 'cloudflare' || envProvider === 'esa' || envProvider === 'edgeone') {
            if (envProvider === 'cloudflare') {
                container.innerHTML = `& <a class="transition link text-[var(--primary)] font-medium inline-flex items-center gap-1 align-middle" target="_blank" href="https://www.cloudflare.com">
                    <img src="/favicon/foot-cloudflare.png" alt="Cloudflare" class="h-4" />
                </a>`;
            } else if (envProvider === 'esa') {
                container.innerHTML = `& <a class="transition link text-[var(--primary)] font-medium inline-flex items-center gap-1 align-middle" target="_blank" href="https://www.aliyun.com/product/esa">
                    <img src="/favicon/foot-esa.png" alt="阿里云ESA" class="h-4" />
                </a>`;
            } else if (envProvider === 'edgeone') {
                container.innerHTML = `& <a class="transition link text-[var(--primary)] font-medium inline-flex items-center gap-1 align-middle" target="_blank" href="https://cloud.tencent.com/product/teo">
                    <img src="/favicon/foot-edgeone.png" alt="腾讯EdgeOne" class="h-4" />
                </a>`;
            }
            return;
        }
        // 不再通过 API / 响应头猜测，避免在纯静态 Pages 环境下各种不兼容
    })();
</script>