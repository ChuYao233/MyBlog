---

import { profileConfig, siteConfig } from "../config";
import { url } from "../utils/url-utils";
import { getBuildInfo } from "../utils/build-info";

const currentYear = new Date().getFullYear();
const buildInfo = getBuildInfo();

// 格式化构建时间
function formatBuildTime(isoString: string): string {
	try {
		const date = new Date(isoString);
		return date.toLocaleString("zh-CN", {
			year: "numeric",
			month: "2-digit",
			day: "2-digit",
			hour: "2-digit",
			minute: "2-digit",
			second: "2-digit",
			timeZone: "Asia/Shanghai",
		});
	} catch {
		return isoString;
	}
}

const formattedBuildTime = formatBuildTime(buildInfo.buildTime);
const repositoryUrl = siteConfig.repository?.url || "";
const branch = siteConfig.repository?.branch || "main";
const commitUrl = buildInfo.commitHash
	? `${repositoryUrl}/commit/${buildInfo.commitHash}`
	: repositoryUrl;

// 检测服务商
function detectServiceProvider(): 'cloudflare' | 'esa' | 'edgeone' | null {
    // 优先从环境变量获取（适用于静态站点构建时指定）
    const envProvider = import.meta.env.PUBLIC_SERVICE_PROVIDER;
    if (envProvider === 'cloudflare' || envProvider === 'esa' || envProvider === 'edgeone') {
        return envProvider;
    }
    
    try {
        // 在SSR模式下，Astro.request 可用
        if (typeof Astro !== 'undefined' && Astro.request) {
            const headers = Astro.request.headers;
            
            // 检测 Cloudflare
            if (headers.get('cf-ray') || headers.get('cf-connecting-ip')) {
                return 'cloudflare';
            }
            
            // 检测阿里云ESA
            const via = headers.get('via') || '';
            const server = headers.get('server') || '';
            if (via.toLowerCase().includes('esa') || server.toLowerCase().includes('esa') || 
                headers.get('x-ali-esa-version') || headers.get('x-ali-esa-id')) {
                return 'esa';
            }
            
            // 检测腾讯EdgeOne
            if (via.toLowerCase().includes('edgeone') || server.toLowerCase().includes('edgeone') ||
                headers.get('x-edgeone-version') || headers.get('x-edgeone-id') ||
                headers.get('x-edgeone-request-id')) {
                return 'edgeone';
            }
        }
    } catch (e) {
        // 在SSG模式下，Astro.request 可能不可用
        // 这种情况下，将在客户端通过JavaScript检测
    }
    
    return null;
}

const serviceProvider = detectServiceProvider();
const envProvider = import.meta.env.PUBLIC_SERVICE_PROVIDER;
---

<div class="transition border-t border-black/10 dark:border-white/15 my-10 border-dashed mx-32"></div>
<div class="card-base card-shadow py-8 mb-12 flex flex-col items-center justify-center px-6">
    <div class="transition text-50 text-sm text-center">
        &copy; 2022 - <span id="copyright-year">{currentYear}</span> <a class="transition link text-[var(--primary)] font-medium" target="_blank" href="https://space.bilibili.com/349638942">{profileConfig.name}</a> 版权所有
        {(buildInfo.commitHash || buildInfo.buildTime) && (
            <span class="text-xs text-gray-500 dark:text-gray-400 ml-2">
                {buildInfo.commitHash && (
                    <>
                        {repositoryUrl ? (
                            <a
                                class="transition link text-[var(--primary)] font-medium"
                                target="_blank"
                                href={commitUrl}
                                title={`Commit: ${buildInfo.commitHash}`}
                            >
                                {buildInfo.commitHash}
                            </a>
                        ) : (
                            <span title={`Commit: ${buildInfo.commitHash}`}>{buildInfo.commitHash}</span>
                        )}
                    </>
                )}
                {buildInfo.commitHash && buildInfo.buildTime && " · "}
                {buildInfo.buildTime && (
                    <span title={`构建时间: ${buildInfo.buildTime}`}>
                        {formattedBuildTime}
                    </span>
                )}
            </span>
        )}
        <br>
        <a class="transition link text-[var(--primary)] font-medium" target="_blank" href={url('rss.xml')}>RSS</a>  /
        <a class="transition link text-[var(--primary)] font-medium" target="_blank" href={url('sitemap-index.xml')}>网页地图</a>  /
        <a class="transition link text-[var(--primary)] font-medium" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"> CC BY-NC-SA 4.0</a><br>
        <span class="inline-flex items-center gap-2">
            <img src="/favicon/foot-ga.png" alt="公安备案" class="inline-block h-4 align-middle" />
            川公网安备51080202020049号
        </span>
        <span class="inline-flex items-center gap-2">
            <img src="/favicon/foot-icp.png" alt="ICP备案" class="inline-block h-4 align-middle" />
            蜀ICP备2024102137号
        </span>
        <br>
        由
        <a class="transition link text-[var(--primary)] font-medium" target="_blank" href="https://astro.build">Astro</a> &
        <a class="transition link text-[var(--primary)] font-medium" target="_blank" href="https://github.com/saicaca/fuwari">Fuwari</a>
        <span id="service-provider-container">
            {serviceProvider === 'cloudflare' && (
                <>
                    & <a class="transition link text-[var(--primary)] font-medium inline-flex items-center gap-1 align-middle" target="_blank" href="https://www.cloudflare.com">
                        <img src="/favicon/foot-cloudflare.png" alt="Cloudflare" class="h-4" />
                    </a>
                </>
            )}
            {serviceProvider === 'esa' && (
                <>
                    & <a class="transition link text-[var(--primary)] font-medium inline-flex items-center gap-1 align-middle" target="_blank" href="https://www.aliyun.com/product/esa">
                        <img src="/favicon/foot-esa.png" alt="阿里云ESA" class="h-4" />
                    </a>
                </>
            )}
            {serviceProvider === 'edgeone' && (
                <>
                    & <a class="transition link text-[var(--primary)] font-medium inline-flex items-center gap-1 align-middle" target="_blank" href="https://cloud.tencent.com/product/teo">
                        <img src="/favicon/foot-edgeone.png" alt="腾讯EdgeOne" class="h-4" />
                    </a>
                </>
            )}
        </span>
        驱动
    </div>
</div>

<script define:vars={{ envProvider }}>
    // 客户端检测服务商（用于SSG模式或服务端检测失败时）
    (async function() {
        const container = document.getElementById('service-provider-container');
        if (!container) return;
        
        // 如果服务端已经检测到了，就不需要客户端检测
        if (container.innerHTML.trim() !== '') return;
        
        // 优先使用环境变量（如果已设置）
        if (envProvider === 'cloudflare' || envProvider === 'esa' || envProvider === 'edgeone') {
            if (envProvider === 'cloudflare') {
                container.innerHTML = `& <a class="transition link text-[var(--primary)] font-medium inline-flex items-center gap-1 align-middle" target="_blank" href="https://www.cloudflare.com">
                    <img src="/favicon/foot-cloudflare.png" alt="Cloudflare" class="h-4" />
                </a>`;
            } else if (envProvider === 'esa') {
                container.innerHTML = `& <a class="transition link text-[var(--primary)] font-medium inline-flex items-center gap-1 align-middle" target="_blank" href="https://www.aliyun.com/product/esa">
                    <img src="/favicon/foot-esa.png" alt="阿里云ESA" class="h-4" />
                </a>`;
            } else if (envProvider === 'edgeone') {
                container.innerHTML = `& <a class="transition link text-[var(--primary)] font-medium inline-flex items-center gap-1 align-middle" target="_blank" href="https://cloud.tencent.com/product/teo">
                    <img src="/favicon/foot-edgeone.png" alt="腾讯EdgeOne" class="h-4" />
                </a>`;
            }
            return;
        }
        
        // 尝试通过 API 检测
        try {
            const response = await fetch('/api/detect-provider');
            if (response.ok) {
                const data = await response.json();
                
                if (data.provider === 'cloudflare') {
                    container.innerHTML = `& <a class="transition link text-[var(--primary)] font-medium inline-flex items-center gap-1 align-middle" target="_blank" href="https://www.cloudflare.com">
                        <img src="/favicon/foot-cloudflare.png" alt="Cloudflare" class="h-4" />
                    </a>`;
                } else if (data.provider === 'esa') {
                    container.innerHTML = `& <a class="transition link text-[var(--primary)] font-medium inline-flex items-center gap-1 align-middle" target="_blank" href="https://www.aliyun.com/product/esa">
                        <img src="/favicon/foot-esa.png" alt="阿里云ESA" class="h-4" />
                    </a>`;
                } else if (data.provider === 'edgeone') {
                    container.innerHTML = `& <a class="transition link text-[var(--primary)] font-medium inline-flex items-center gap-1 align-middle" target="_blank" href="https://cloud.tencent.com/product/teo">
                        <img src="/favicon/foot-edgeone.png" alt="腾讯EdgeOne" class="h-4" />
                    </a>`;
                }
            }
        } catch (error) {
            // API 不可用（静态站点模式），尝试通过检查响应头检测
            try {
                // 通过 fetch 当前页面来检查响应头
                const pageResponse = await fetch(window.location.href, { method: 'HEAD' });
                const headers = pageResponse.headers;
                
                // 检测 Cloudflare
                if (headers.get('cf-ray') || headers.get('cf-connecting-ip')) {
                    container.innerHTML = `& <a class="transition link text-[var(--primary)] font-medium inline-flex items-center gap-1 align-middle" target="_blank" href="https://www.cloudflare.com">
                        <img src="/favicon/foot-cloudflare.png" alt="Cloudflare" class="h-4" />
                    </a>`;
                    return;
                }
                
                // 检测阿里云ESA
                const via = headers.get('via') || '';
                const server = headers.get('server') || '';
                if (via.toLowerCase().includes('esa') || server.toLowerCase().includes('esa') || 
                    headers.get('x-ali-esa-version') || headers.get('x-ali-esa-id')) {
                    container.innerHTML = `& <a class="transition link text-[var(--primary)] font-medium inline-flex items-center gap-1 align-middle" target="_blank" href="https://www.aliyun.com/product/esa">
                        <img src="/favicon/foot-esa.png" alt="阿里云ESA" class="h-4" />
                    </a>`;
                    return;
                }
                
                // 检测腾讯EdgeOne
                if (via.toLowerCase().includes('edgeone') || server.toLowerCase().includes('edgeone') ||
                    headers.get('x-edgeone-version') || headers.get('x-edgeone-id') ||
                    headers.get('x-edgeone-request-id')) {
                    container.innerHTML = `& <a class="transition link text-[var(--primary)] font-medium inline-flex items-center gap-1 align-middle" target="_blank" href="https://cloud.tencent.com/product/teo">
                        <img src="/favicon/foot-edgeone.png" alt="腾讯EdgeOne" class="h-4" />
                    </a>`;
                    return;
                }
            } catch (headerError) {
                // 静默失败，不显示服务商logo
                console.debug('Failed to detect service provider:', headerError);
            }
        }
    })();
</script>