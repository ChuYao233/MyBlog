---
import path from "node:path";

interface Props {
	id?: string;
	src: string;
	class?: string;
	alt?: string;
	position?: string;
	basePath?: string;
}

import { Image } from "astro:assets";
import { url } from "../../utils/url-utils";

const { id, src, alt, position = "center", basePath = "/" } = Astro.props;
const className = Astro.props.class;

const isLocal = !(
	src.startsWith("/") ||
	src.startsWith("http") ||
	src.startsWith("https") ||
	src.startsWith("data:")
);
const isPublic = src.startsWith("/");

// TODO temporary workaround for images dynamic import
// https://github.com/withastro/astro/issues/3373
// biome-ignore lint/suspicious/noImplicitAnyLet: <check later>
let img;
if (isLocal) {
	const files = import.meta.glob<ImageMetadata>("../../**", {
		import: "default",
	});
	let normalizedPath = path
		.normalize(path.join("../../", basePath, src))
		.replace(/\\/g, "/");
	const file = files[normalizedPath];
	if (!file) {
		console.error(
			`\n[ERROR] Image file not found: ${normalizedPath.replace("../../", "src/")}`,
		);
	}
	img = await file();
}

const imageClass = "w-full h-full object-cover";
const imageStyle = `object-position: ${position}`;
---
<div id={id} class:list={[className, 'overflow-hidden relative']}>
    <div class="transition absolute inset-0 dark:bg-black/10 bg-opacity-50 pointer-events-none z-10"></div>
    
    <!-- 加载动画 -->
    <div class="image-skeleton absolute inset-0 flex items-center justify-center bg-black/5 dark:bg-white/5 z-20">
        <div class="image-spinner">
            <svg class="animate-spin" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" stroke="var(--primary)" fill="none"></circle>
                <path class="opacity-75" fill="currentColor" fill="var(--primary)" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>
    </div>
    
    <!-- 本地图片 -->
    {isLocal && img && (
        <Image 
            src={img} 
            alt={alt || ""} 
            class:list={[imageClass, "image-content opacity-0 transition-opacity duration-300"]} 
            style={imageStyle}
            onload="this.classList.add('opacity-100'); this.closest('.overflow-hidden')?.querySelector('.image-skeleton')?.classList.add('hidden');"
        />
    )}
    
    <!-- 远程图片 -->
    {!isLocal && (
        <img 
            src={isPublic ? url(src) : src} 
            alt={alt || ""} 
            class:list={[imageClass, "image-content opacity-0 transition-opacity duration-300"]} 
            style={imageStyle}
            onload="this.classList.add('opacity-100'); this.closest('.overflow-hidden')?.querySelector('.image-skeleton')?.classList.add('hidden');"
            onerror="this.classList.add('hidden'); this.closest('.overflow-hidden')?.querySelector('.image-error')?.classList.remove('hidden'); this.closest('.overflow-hidden')?.querySelector('.image-skeleton')?.classList.add('hidden');"
        />
    )}
    
    <!-- 错误占位图 -->
    <div class="image-error hidden absolute inset-0 flex flex-col items-center justify-center bg-black/5 dark:bg-white/5 text-black/30 dark:text-white/30 z-30">
        <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
        </svg>
        <span class="text-xs text-center px-2">图片加载失败</span>
    </div>
</div>

<style>
    .image-content.opacity-100 {
        opacity: 1;
    }
    
    .image-spinner {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }
</style>
