---
import type { CollectionEntry } from "astro:content";
import { getPostUrlBySlug } from "@utils/url-utils";
import PostCard from "./PostCard.astro";

const { page } = Astro.props;

let delay = 0;
const interval = 50;
const slugs = page.data.map((entry: CollectionEntry<"posts">) => entry.slug);
const uniqueSlugs = Array.from(new Set(slugs)).filter(Boolean);
const pagePaths = uniqueSlugs.map(getPostUrlBySlug);
---
<div class="transition flex flex-col rounded-[var(--radius-large)] bg-[var(--card-bg)] py-1 md:py-0 md:bg-transparent md:gap-4 mb-4">
    {page.data.map((entry: CollectionEntry<"posts">) => (
        <PostCard
                entry={entry}
                title={entry.data.title}
                tags={entry.data.tags}
                category={entry.data.category}
                published={entry.data.published}
                updated={entry.data.updated}
                url={getPostUrlBySlug(entry.slug)}
                image={entry.data.image}
                description={entry.data.description}
                draft={entry.data.draft}
                class:list="onload-animation"
                style={`animation-delay: calc(var(--content-delay) + ${delay++ * interval}ms);`}
        ></PostCard>
    ))}
</div>

<script type="application/json" id="post-paths-data" set:html={JSON.stringify({ slugs: uniqueSlugs, paths: pagePaths })}>
</script>

<script>
    function formatNumber(num) {
        if (num >= 10000) {
            const w = num / 10000;
            return Number.isInteger(w) ? `${w}w` : `${w.toFixed(2)}w`;
        }
        if (num >= 1000) {
            const k = num / 1000;
            return Number.isInteger(k) ? `${k}k` : `${k.toFixed(2)}k`;
        }
        return num.toString();
    }

    /**
     * 老虎机滚动数字动画
     * @param {HTMLElement} element - 要更新的元素
     * @param {number} targetValue - 目标数值
     * @param {number} duration - 动画时长（毫秒），默认1500ms
     */
    function animateNumber(element, targetValue, duration = 1500) {
        if (!element) return;
        
        const startValue = 0;
        const startTime = performance.now();
        
        // 缓动函数：easeOutCubic，让动画开始快，结束慢
        function easeOutCubic(t) {
            return 1 - Math.pow(1 - t, 3);
        }
        
        function update(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const easedProgress = easeOutCubic(progress);
            
            // 计算当前值
            const currentValue = Math.floor(startValue + (targetValue - startValue) * easedProgress);
            
            // 更新显示
            const formatted = formatNumber(currentValue);
            element.textContent = formatted;
            element.title = targetValue.toLocaleString();
            
            // 如果还没到达目标值，继续动画
            if (progress < 1) {
                requestAnimationFrame(update);
            } else {
                // 确保最终显示目标值
                element.textContent = formatNumber(targetValue);
                element.title = targetValue.toLocaleString();
            }
        }
        
        requestAnimationFrame(update);
    }

    function updateStat(container, stats) {
        if (!container || !stats) return;
        const viewsEl = container.querySelector(".post-views");
        const visitorsEl = container.querySelector(".post-visitors");
        if (viewsEl) {
            animateNumber(viewsEl, stats.views || 0);
        }
        if (visitorsEl) {
            animateNumber(visitorsEl, stats.uniqueVisitors || 0);
        }
    }

    // Umami API 客户端函数
    const UMAMI_BASE_URL = 'https://umami.2o.nz';
    const SHARE_ID = 'kek80GxcLVqvtJRg';
    let shareDataCache = null;
    const SHARE_CACHE_TTL = 3600_000; // 1小时
    
    async function getUmamiShareData() {
        const now = Date.now();
        if (shareDataCache && (now - shareDataCache.timestamp) < SHARE_CACHE_TTL) {
            return shareDataCache.data;
        }
        
        const url = `${UMAMI_BASE_URL}/api/share/${SHARE_ID}`;
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`获取 Umami 分享信息失败: ${response.status}`);
        }
        
        const data = await response.json();
        shareDataCache = { data, timestamp: now };
        return data;
    }
    
    async function getPageStatsClient(pagePath) {
        try {
            const { websiteId, token } = await getUmamiShareData();
            const currentTimestamp = Date.now();
            
            const params = new URLSearchParams({
                startAt: '0',
                endAt: currentTimestamp.toString(),
                unit: 'hour',
                timezone: 'Asia/Shanghai',
                compare: 'false',
                path: `eq.${pagePath}`,
            });
            
            const statsUrl = `${UMAMI_BASE_URL}/api/websites/${websiteId}/stats?${params.toString()}`;
            const response = await fetch(statsUrl, {
                headers: {
                    'x-umami-share-token': token,
                },
            });
            
            if (!response.ok) {
                if (response.status === 401) {
                    shareDataCache = null;
                    return await getPageStatsClient(pagePath);
                }
                return null;
            }
            
            const data = await response.json();
            const pageviewsValue = typeof data.pageviews === 'object' && data.pageviews !== null 
                ? data.pageviews.value 
                : (data.pageviews || 0);
            const visitorsValue = typeof data.visitors === 'object' && data.visitors !== null 
                ? data.visitors.value 
                : (data.visitors || 0);
            
            return {
                pageviews: { value: pageviewsValue },
                uniques: { value: visitorsValue },
            };
        } catch (error) {
            console.error(`Failed to fetch Umami page stats for ${pagePath}:`, error);
            return null;
        }
    }
    
    async function getMultiplePageStatsClient(pagePaths) {
        const result = {};
        const promises = pagePaths.map(async (path) => {
            const stats = await getPageStatsClient(path);
            if (stats) {
                result[path] = stats;
            } else {
                result[path] = { pageviews: { value: 0 }, uniques: { value: 0 } };
            }
        });
        await Promise.all(promises);
        return result;
    }

    // 在客户端实时获取文章统计数据
    (function () {
        if (typeof window === "undefined") return;
        
        async function initPostStats() {
            try {
                // 从 script 标签中读取文章路径数据
                const dataScript = document.getElementById('post-paths-data');
                let slugs = [];
                let pagePaths = [];
                
                if (dataScript && dataScript.textContent) {
                    try {
                        const rawData = dataScript.textContent.trim();
                        const data = JSON.parse(rawData);
                        slugs = data.slugs || [];
                        pagePaths = data.paths || [];
                    } catch (e) {
                        console.error('Failed to parse post paths data:', e);
                        return;
                    }
                } else {
                    console.warn('未找到 post-paths-data 脚本标签');
                    return;
                }
                
                // 显示初始状态（从0开始）
                const cards = document.querySelectorAll("[data-post-slug]");
                cards.forEach((card) => {
                    const statBox = card.querySelector("[data-post-stats]");
                    if (statBox) {
                        const viewsEl = statBox.querySelector(".post-views");
                        const visitorsEl = statBox.querySelector(".post-visitors");
                        if (viewsEl) viewsEl.textContent = '0';
                        if (visitorsEl) visitorsEl.textContent = '0';
                    }
                });
                
                // 获取所有文章的统计数据
                const umamiStats = await getMultiplePageStatsClient(pagePaths);
                
                // 将 Umami 数据映射回 slug 并更新显示
                cards.forEach((card) => {
                    const slug = card.getAttribute("data-post-slug");
                    const slugIndex = slugs.indexOf(slug);
                    if (slugIndex >= 0 && slugIndex < pagePaths.length) {
                        const pagePath = pagePaths[slugIndex];
                        const umamiData = umamiStats[pagePath];
                        
                        if (umamiData) {
                            const stats = {
                                views: umamiData.pageviews.value || 0,
                                uniqueVisitors: umamiData.uniques.value || 0,
                            };
                            const statBox = card.querySelector("[data-post-stats]");
                            updateStat(statBox, stats);
                        } else {
                            const statBox = card.querySelector("[data-post-stats]");
                            updateStat(statBox, { views: 0, uniqueVisitors: 0 });
                        }
                    }
                });
            } catch (error) {
                console.error("Failed to load post stats:", error);
            }
        }
        
        // 确保 DOM 加载完成后再执行
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initPostStats);
        } else {
            // DOM 已经加载完成，立即执行
            initPostStats();
        }
    })();
</script>